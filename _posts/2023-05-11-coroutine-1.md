title: '协程（1） - 基础总结'
author: litao
date: 2023-05-11 17:13:00 +0800
categories: [Kotlin,Course,Coroutine]
tags: [Course,Kotlin,Coroutine]



## 一、什么是协程

官方定义为轻量级的线程，本质上是一个线程框架，在协程作用域内实现局部代码的执行挂起，让异步代码的编写达到与正常代码一样的线形结构。

相对直接使用线程，具有以下特点

- 轻量：可在单个线程中启动多个协程，并且不会因为协程的执行或挂起导致线程的阻塞
- 内存泄露更少：因为协程结构化并发的机制，可以轻松的中断同一作用域下所有协程，Android中可关联组件的生命周期来达到自动取消。
- 取消操作：协程内置的取消可以自动在协层的层次结构中传播，而且允许进行配置。

## 二、协程作用域

协程需要在协程作用域内运行，为了框架对任务的统一追踪管理，常见的作用域有以下几种

1. GlobalScope: 顶协程，跟随应用进程的生命周期，此作用域不受结构化并发规则的约束。使用时需要注意，可能由于网络原因导致挂起或延迟后，它会一直在后台消耗资源直到耗尽为止，使用时需要特别注意内存泄露问题。只有业务需要跟随应用整个生命周期时再考虑使用，例如：日志记录上报逻辑等。

2. MainScope: 系统提供的通用作用域，可直接使用，但通常我们需要结合业务的生命周期，手动去取消任务。

3. LifecycleScope: 这是结合Android包含生命周期的组件官方自定义的作用域，它能够自动关联到组件的生命周期，自动进行取消。类似的还有viewModelScope.

4. 自定义作用域

	   CoroutineScope由多个`CoroutineContext`元素进行声明描述，其中包括
	   
	   - Job：用于控制协程的生命周期。
	   - Dispatcher： 线程调度器，用于指定协程运行的线程或线程池
	   - CoroutineName：协程名称，有助于调试或排查问题
	   - CoroutineExceptionHandler：处理为捕获的异常

## 三、启动协程

1. launch：大多情况我们都是通过此方法来启动，此方法会返回当前的Job,并不会返回执行结果，
2. async: 启动一个新协程，并允许使用await关键字来获取返回结果。通常用来处理一些并发任务。
3. runBlocking: 启动一个阻塞的协程。

## 四、协程间的通信

通常使用`Channel`进行协程之间的通信，应该尽量避免直接去定义一些共享状态。定义时最好按需指定好缓存区大小。

## 五、协程的取消和超时

取消通常有以下方式

- cancel：协程会立即中断进入取消状态，不会阻塞调用方
- cancelAndJoin：协程会等待任务都执行完毕，会阻塞调用方，知道完全结束

如果作用域内部分逻辑我们不希望取消，可以使用`withContext`传递NonCancellable上下文来达到不可取消的目的。

超时通常有以下方式

- withTimeout: 超时后直接抛出`TimeoutCancellationException`，通过异常来处理后续逻辑

- withTimeoutOrNull：超时时会返回null

  
